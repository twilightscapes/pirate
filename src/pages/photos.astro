---
import { Image } from 'astro:assets';
import PageLayout from "@/layouts/Base.astro";
import GalleryLightbox from '../components/GalleryLightbox';

// Attempt to glob images from multiple possible locations
const imageFiles = await Astro.glob([
  '/src/assets/images/**/*.{jpg,jpeg,png,gif,webp,avif}',
  '/public/images/**/*.{jpg,jpeg,png,gif,webp,avif}',
  '/images/**/*.{jpg,jpeg,png,gif,webp,avif}'
]);

const images = imageFiles.map(file => ({
  src: file.default,
  alt: file.default.src.split('/').pop().split('.')[0],
  title: file.default.src.split('/').pop().split('.')[0]
}));

const directories = [...new Set(images.map(img => {
  const pathParts = img.src.src.split('/');
  return pathParts[pathParts.indexOf('images') + 1];
}))];

const meta = {
  description: "Image Gallery",
  title: "Image Gallery",
  ogImage: "",
  articleDate: ""
};
---
<PageLayout meta={meta}>
  <select id="directorySelect">
    <option value="all">All Images</option>
    {directories.map((dir) => (
      <option value={dir}>{dir}</option>
    ))}
  </select>

  <div class="contentpanel grid-container panels" style="margin-top:2vh">
    {images.map((image) => {
      const directory = image.src.src.split('/')[image.src.src.split('/').indexOf('images') + 1];
      return (
        <div class="post-card1" data-directory={directory}>
          <Image 
            src={image.src} 
            alt={image.alt}
            width={300}
            height={300}
          />
          <div class="image-caption">
            {image.title}
          </div>
        </div>
      );
    })}
  </div>

  <GalleryLightbox client:only="react" images={images.map(img => ({
    src: img.src.src,
    alt: img.alt,
    title: img.title
  }))} />
</PageLayout><style>
  .post-card1 {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .image-caption {
    margin-top: 8px;
    text-align: center;
    font-size: 14px;
    color: #666;
  }
</style>

<script>
  const directorySelect = document.getElementById('directorySelect');
  const galleryContainer = document.querySelector('.contentpanel');

  directorySelect.addEventListener('change', (event) => {
    const selectedDir = event.target.value;
    const images = galleryContainer.querySelectorAll('.post-card1');
    
    images.forEach((image) => {
      const imageDir = image.dataset.directory;
      if (selectedDir === 'all' || imageDir === selectedDir) {
        image.style.display = 'block';
      } else {
        image.style.display = 'none';
      }
    });
  });
</script>
